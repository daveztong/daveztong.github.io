<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Spring可扩展的XML配置 | 三唐</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring可扩展的XML配置</h1><a id="logo" href="/.">三唐</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Spring可扩展的XML配置</h1><div class="post-meta"><a href="/2016/11/01/Spring可扩展的XML配置/#comments" class="comment-count"></a><p><span class="date">Nov 01, 2016</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h1 id="Spring-可扩展的XML配置"><a href="#Spring-可扩展的XML配置" class="headerlink" title="Spring 可扩展的XML配置"></a>Spring 可扩展的XML配置</h1><p>Spring 自从2.0开始就为基础的xml格式提供了一个基于xml schema的扩展机制，用于定义和配置beans。本文基于此简单讲解如果定义自己的<code>BeanDefinitionParser</code>和如何将定义好的<code>parsers</code>集成到<code>Spring IoC container</code>中。</p>
<p>创建一个xml配置扩展可以通过以下4步完成：</p>
<ol>
<li>创建一个xml schema来描述你自定的xml元素。</li>
<li>编写一个<code>NamespaceHandler</code>的具体实现。</li>
<li>编写一个或者多个<code>BeanDefinitionParser</code>的实现。主要的工作都在此步骤完成。</li>
<li>关联<code>xsd</code>,<code>NamespaceHandler</code>。</li>
</ol>
<p>下面依照以上四个步骤并附一个示例详细讲解。完整代码放在码云上:<a href="https://git.oschina.net/android-speeder/springcustomxml.git" target="_blank" rel="external">https://git.oschina.net/android-speeder/springcustomxml.git</a></p>
<a id="more"></a>
<h2 id="创建schema文件"><a href="#创建schema文件" class="headerlink" title="创建schema文件"></a>创建schema文件</h2><p>创建一个spring可以用的xml配置扩展首先需要定义一个xml schema来描述这个扩展。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://daveztong.github.io/schema/dz"</span></span></div><div class="line"><span class="tag">            <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></span></div><div class="line"><span class="tag">            <span class="attr">xmlns:beans</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">            <span class="attr">targetNamespace</span>=<span class="string">"http://daveztong.github.io/schema/dz"</span></span></div><div class="line"><span class="tag">            <span class="attr">elementFormDefault</span>=<span class="string">"qualified"</span></span></div><div class="line"><span class="tag">            <span class="attr">attributeFormDefault</span>=<span class="string">"unqualified"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"person"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">xsd:extension</span> <span class="attr">base</span>=<span class="string">"beans:identifiedType"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>/&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">type</span>=<span class="string">"xsd:int"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">xsd:extension</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注意<code>&lt;xsd:extension base=&quot;beans:identifiedType&quot;&gt;</code>表示该tag含有一个id属性并且会被spring container用于识别该bean。使用该属性的前提是需要导入<code>&lt;xsd:import namespace=&quot;http://www.springframework.org/schema/beans&quot;/&gt;</code>。</p>
<h2 id="实现NamespaceHandler"><a href="#实现NamespaceHandler" class="headerlink" title="实现NamespaceHandler"></a>实现NamespaceHandler</h2><p>当spring在解析xml时遇到该namespace就需要使用自定义的<code>Namespacehandler</code>去解析所有该名称空间下的元素。</p>
<p><code>NamespaceHandler</code>只包含三个方法:</p>
<ul>
<li><code>init()</code>: 用于初始化<code>NamespaceHandler</code>。</li>
<li><code>BeanDefinition parse(Element, ParserContext)</code>：当spring遇到顶级的元素时才会调用。该方法可以直接返回一个bean definition或者自己注册一个。</li>
<li><code>BeanDefinitionHolder decorate(Node, BeanDefinitionHolder, ParserContext)</code>:当spring遇到属性定义或者嵌套在不同名称空间下的元素时才会被调用。</li>
</ul>
<p>我们可以自己实现<code>NamespaceHandler</code>,但是基于spring的惯例，一般都会提供一个基础类简化开发人员的工作，所以我们可以直接继承spring提供的<code>NamespaceHandlerSupport</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.github.daveztong;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by tangwei on 2016/10/31.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DZNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        registerBeanDefinitionParser(<span class="string">"person"</span>,<span class="keyword">new</span> PersonBeanDefinitionParser());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到<code>DZNamespaceHandler</code>的代码量很少，因为真正的解析工作都委托给了<code>BeanDefinitionParser</code>。    <code>NamespaceHandler</code>支持注册任意多个<code>BeanDefinitionParser</code>,当其需要解析其所负责的名称空间下的元素时就会将解析工作委托给注册的<code>BeanDefinitionParser</code>。</p>
<h2 id="实现BeanDefinitionParser"><a href="#实现BeanDefinitionParser" class="headerlink" title="实现BeanDefinitionParser"></a>实现<code>BeanDefinitionParser</code></h2><p>当<code>NamespaceHandler</code>遇到一个与注册列表中key匹配的xml元素时就会将该元素的解析任务交给与key对应的<code>BeanDefinitionParser</code>。在本例中则是<code>PersonBeanDefinitionParser</code>。也就是说一个<code>BeanDefinitionParser</code>仅负责解析定义在指定schema中的一个唯一顶级的xml元素。在parser中我们可以访问到其负责解析的元素和子元素的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.github.daveztong;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;</div><div class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</div><div class="line"><span class="keyword">import</span> org.w3c.dom.Element;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by tangwei on 2016/10/31.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</div><div class="line">        <span class="keyword">return</span> Person.class;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</div><div class="line">        String name = element.getAttribute(<span class="string">"name"</span>);</div><div class="line">        <span class="keyword">if</span> (StringUtils.hasText(name)) &#123;</div><div class="line">            builder.addPropertyValue(<span class="string">"name"</span>, name);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String age = element.getAttribute(<span class="string">"age"</span>);</div><div class="line">        <span class="keyword">if</span> (StringUtils.hasText(age)) &#123;</div><div class="line">            builder.addPropertyValue(<span class="string">"age"</span>, Integer.parseInt(age));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编码部分就这么多，是不是so easy! 可能有人会疑问，为什么没有看到<code>BeanDefiniiton</code>的创建，那是因为创建的工作由<code>AbstractSingleBeanDefinitionParser#parseInternal</code>完成了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> AbstractBeanDefinition <span class="title">parseInternal</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">		BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</div><div class="line">		String parentName = getParentName(element);</div><div class="line">		<span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</div><div class="line">			builder.getRawBeanDefinition().setParentName(parentName);</div><div class="line">		&#125;</div><div class="line">		Class&lt;?&gt; beanClass = getBeanClass(element);</div><div class="line">		<span class="keyword">if</span> (beanClass != <span class="keyword">null</span>) &#123;</div><div class="line">			builder.getRawBeanDefinition().setBeanClass(beanClass);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			String beanClassName = getBeanClassName(element);</div><div class="line">			<span class="keyword">if</span> (beanClassName != <span class="keyword">null</span>) &#123;</div><div class="line">				builder.getRawBeanDefinition().setBeanClassName(beanClassName);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</div><div class="line">		<span class="keyword">if</span> (parserContext.isNested()) &#123;</div><div class="line">			<span class="comment">// Inner bean definition must receive same scope as containing bean.</span></div><div class="line">			builder.setScope(parserContext.getContainingBeanDefinition().getScope());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (parserContext.isDefaultLazyInit()) &#123;</div><div class="line">			<span class="comment">// Default-lazy-init applies to custom bean definitions as well.</span></div><div class="line">			builder.setLazyInit(<span class="keyword">true</span>);</div><div class="line">		&#125;</div><div class="line">		doParse(element, parserContext, builder);</div><div class="line">		<span class="keyword">return</span> builder.getBeanDefinition();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>The last statement <code>builder.getBeanDefinition();</code>返回了我们需要的bean. 继续看builder.getBeanDefinition()的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">getBeanDefinition</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.beanDefinition.validate();</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.beanDefinition;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>That’s our bean!</p>
<p>编码部分是完成了，但是spring还不知道他们的存在，接下来就需要让spring aware of them!(aware是个很关键的词啊，在spring的代码里随处可见^_^)</p>
<h2 id="注册handler-and-schema"><a href="#注册handler-and-schema" class="headerlink" title="注册handler and schema"></a>注册handler and schema</h2><p>要让spring aware of out handler and xsd schema,我们需要在两个特殊的properties文件中注册他们。这些properties文件需要放在<code>META-INF</code>目录下面,并且可以和jar包一起发布。spring的解析框架通过这些特殊的properties文件就能pick up our handler and schema!</p>
<h3 id="META-INF-spring-handlers"><a href="#META-INF-spring-handlers" class="headerlink" title="META-INF/spring.handlers"></a>META-INF/spring.handlers</h3><p><code>spring.handlers</code>包含了 xml schema uri 和namespace handler之间的k-v映射关系，如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://daveztong.github.io/schema/dz=io.github.daveztong.DZNamespaceHandler</div></pre></td></tr></table></figure>
<p>注意，因为<code>:</code>在properties文件中是个合法的分隔符，所以需要escape以下！</p>
<p>其中URI部分是自定义的namespace扩展，必须与xsd中的<code>targetNamespace</code>完全匹配。</p>
<h3 id="META-INF-spring-schemas"><a href="#META-INF-spring-schemas" class="headerlink" title="META-INF/spring.schemas"></a>META-INF/spring.schemas</h3><p><code>spring.schemas</code>中包含了xml schema uri(对应<code>xsi:schemaLocation</code>的值)与classpath resources的映射关系。如果这个文件不存在，spring默认会从网上加载<code>xsi:schemaLocation</code>中所定义的schema。有个这个映射文件，spring就会从classpath中加载而不再联网查找。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://daveztong.github.io/schema/dz/dz.xsd=io/github/daveztong/schema/dz/dz.xsd</div></pre></td></tr></table></figure>
<h2 id="Now-time-to-test"><a href="#Now-time-to-test" class="headerlink" title="Now,time to test"></a>Now,time to test</h2><p>使用xml定义person bean: spring-beans.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:dz</span>=<span class="string">"http://daveztong.github.io/schema/dz"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></div><div class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></div><div class="line"><span class="tag"><span class="string">http://daveztong.github.io/schema/dz http://daveztong.github.io/schema/dz/dz.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- as a top-level bean --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dz:person</span> <span class="attr">age</span>=<span class="string">"22"</span> <span class="attr">id</span>=<span class="string">"person"</span> <span class="attr">name</span>=<span class="string">"tangwei"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>为了演示效果，这里使用spring boot来快速测试: <code>App.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.github.daveztong;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</div><div class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportResource;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.Resource;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by tangwei on 2016/11/1.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@EnableAutoConfiguration</span></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:spring-beans.xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> Person person;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(App.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showPerson</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> person.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>访问<a href="http://localhost:8080/" target="_blank" rel="external">http://localhost:8080/</a> ,dada:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person&#123;age=22, name=&apos;tangwei&apos;&#125;</div></pre></td></tr></table></figure>
<p>说了这么多，到底谁在用这个，能干啥呢！</p>
<h2 id="Dubbo-xml-配置扩展"><a href="#Dubbo-xml-配置扩展" class="headerlink" title="Dubbo xml 配置扩展"></a>Dubbo xml 配置扩展</h2><p>Dubbo 在国内开源RPC界算是比较知名的，她其实采用的就是这种方式解析自定义的配置。dubbo jar 包结构:</p>
<p><img src="http://ww4.sinaimg.cn/large/94dc19degw1f9cgo55oetj209q06hmxg.jpg" alt="dubbo jar structure"></p>
<p>spring.handlers:</p>
<p><code>http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</code></p>
<p>spring.schemas:</p>
<p><code>http\://code.alibabatech.com/schema/dubbo/dubbo.xsd=META-INF/dubbo.xsd</code></p>
<p>NamespaceHandler实现为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		Version.checkDuplicate(DubboNamespaceHandler.class);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">	    registerBeanDefinitionParser(<span class="string">"application"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ApplicationConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"module"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ModuleConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"registry"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(RegistryConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"monitor"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(MonitorConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"provider"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ProviderConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"consumer"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ConsumerConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"protocol"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ProtocolConfig.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"service"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ServiceBean.class, <span class="keyword">true</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"reference"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ReferenceBean.class, <span class="keyword">false</span>));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"annotation"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(AnnotationBean.class, <span class="keyword">true</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该handler注册了所有的bean definition parser!</p>
<p>了解这种机制后，我们也可以根据自己需要做任何配置扩展。So cool!</p>
</div><div class="tags"><a href="/tags/dubbo/">dubbo</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2016/11/23/Dubbo学习-理解动态代理/" class="pre">Dubbo学习-理解动态代理</a><a href="/2016/07/18/bootcamp/" class="next">bootcamp</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-可扩展的XML配置"><span class="toc-text">Spring 可扩展的XML配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建schema文件"><span class="toc-text">创建schema文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现NamespaceHandler"><span class="toc-text">实现NamespaceHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现BeanDefinitionParser"><span class="toc-text">实现BeanDefinitionParser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注册handler-and-schema"><span class="toc-text">注册handler and schema</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#META-INF-spring-handlers"><span class="toc-text">META-INF/spring.handlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#META-INF-spring-schemas"><span class="toc-text">META-INF/spring.schemas</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Now-time-to-test"><span class="toc-text">Now,time to test</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dubbo-xml-配置扩展"><span class="toc-text">Dubbo xml 配置扩展</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/06/wkhtmltopdf折腾记/">wkhtmltopdf折腾记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/06/日志清理脚本-md/">日志清理脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/Dubbo学习-理解动态代理/">Dubbo学习-理解动态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/Spring可扩展的XML配置/">Spring可扩展的XML配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/18/bootcamp/">bootcamp</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/深入理解HashMap/">深入理解HashMap</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/22/effective-java-methods/">effective-java-methods</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/how-to-create-products-customers-love/">how-to-create-products-customers-love</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/27/Build-rest-api/">Build-rest-api</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/03/RESTAPI-Reference/">RESTAPI-Reference</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/effective/" style="font-size: 15px;">effective</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/javassist/" style="font-size: 15px;">javassist</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/PM/" style="font-size: 15px;">PM</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/wkhtmltopdf/" style="font-size: 15px;">wkhtmltopdf</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">About</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">三唐.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>