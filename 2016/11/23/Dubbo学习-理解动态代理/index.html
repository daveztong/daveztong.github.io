<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Dubbo学习-理解动态代理 | 三唐</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Dubbo学习-理解动态代理</h1><a id="logo" href="/.">三唐</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Dubbo学习-理解动态代理</h1><div class="post-meta"><a href="/2016/11/23/Dubbo学习-理解动态代理/#comments" class="comment-count"></a><p><span class="date">Nov 23, 2016</span><span><a href="/categories/dubbo/" class="category">dubbo</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h1 id="Dubbo学习-理解动态代理"><a href="#Dubbo学习-理解动态代理" class="headerlink" title="Dubbo学习-理解动态代理"></a>Dubbo学习-理解动态代理</h1><p>在之前的一篇post中了解了<a href="http://daveztong.github.io/2016/11/01/Spring%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84XML%E9%85%8D%E7%BD%AE/" target="_blank" rel="external">spring可扩展的XML配置</a>是怎么一会事，接下来继续研究dubbo consumer端如何解析service并执行远程调用。</p>
<h2 id="本次研究目标"><a href="#本次研究目标" class="headerlink" title="本次研究目标"></a>本次研究目标</h2><ol>
<li>代理如何创建的。仅仅只是配置了<code>&lt;dubbo:reference interface=&quot;x.y.z.ServiceInterface&quot; id=&quot;serviceId&quot;/&gt;</code>并将其交给了spring container，然后直接注入并使用该接口的方法就可以完成调用了，然而我并没有为该接口实现具体的类，how does it works? </li>
<li><del>远程调用如何执行的。假设已经有了具体的实现类，怎么实现远程调用的呢，Thingking?</del> 由于第一个分析就很长，这个目标列入下一次分析。</li>
</ol>
<a id="more"></a>
<h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>为了顺利的研究上述两个目标，需要了解以下知识:</p>
<ol>
<li>SPI. <a href="https://docs.oracle.com/javase/tutorial/ext/basics/spi.html" target="_blank" rel="external">官方教程</a>。用于服务扩展。</li>
<li>Netty. <a href="http://netty.io/wiki/user-guide-for-4.x.html" target="_blank" rel="external">User Guide</a>。用于远程调用。</li>
<li>Javassist. <a href="https://jboss-javassist.github.io/javassist/tutorial/tutorial.html" target="_blank" rel="external">官方Tutorial</a>。动态类生成。</li>
</ol>
<h2 id="How-to-dig-in"><a href="#How-to-dig-in" class="headerlink" title="How to dig in?"></a>How to dig in?</h2><p>从何处入手是个问题，我的习惯是顺藤摸瓜，所以从service被注入开始:</p>
<p>dubbo service配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- DemoService is just a interface --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">"x.y.z.DemoService"</span> <span class="attr">id</span>=<span class="string">"demoService"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>Service注入:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Resource</span></div><div class="line"><span class="keyword">private</span> DemoService demoService;</div></pre></td></tr></table></figure>
<p>当使用这个<code>demoService</code>的时候可以肯定的是一定有个DemoService的具体实现可供使用，<code>DubboNamespaceHandler</code>中有这样一段代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">registerBeanDefinitionParser(<span class="string">"reference"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ReferenceBean.class,<span class="keyword">false</span>));</div></pre></td></tr></table></figure>
<p>解析上面配置在namespace dubbo下的reference。<code>DubboBeanDefinitionParser</code>相关代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">DubboBeanDefinitionParser</span><span class="params">(Class&lt;?&gt; beanClass, <span class="keyword">boolean</span> required)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.beanClass = beanClass;</div><div class="line">  <span class="keyword">this</span>.required = required;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> parse(element, parserContext, beanClass, required);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 关键部分</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, <span class="keyword">boolean</span> required)</span> </span>&#123;</div><div class="line">    RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition();</div><div class="line">    <span class="comment">// 设置bean class,in this case it is ReferenceBean.class</span></div><div class="line">    beanDefinition.setBeanClass(beanClass);</div><div class="line">    beanDefinition.setLazyInit(<span class="keyword">false</span>);</div><div class="line">    String id = element.getAttribute(<span class="string">"id"</span>);</div><div class="line">    <span class="comment">// some ops...</span></div><div class="line">    <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (parserContext.getRegistry().containsBeanDefinition(id))  &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate spring bean id "</span> + id);</div><div class="line">        &#125;</div><div class="line">        parserContext.getRegistry().registerBeanDefinition(id, beanDefinition);</div><div class="line">        beanDefinition.getPropertyValues().addPropertyValue(<span class="string">"id"</span>, id);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// some ops...</span></div><div class="line"></div><div class="line">    <span class="comment">// 遍历setter and getter设置属性值</span></div><div class="line">    <span class="keyword">for</span> (Method setter : beanClass.getMethods()) &#123;</div><div class="line">        String name = setter.getName();</div><div class="line">        <span class="keyword">if</span> (name.length() &gt; <span class="number">3</span> &amp;&amp; name.startsWith(<span class="string">"set"</span>)</div><div class="line">                &amp;&amp; Modifier.isPublic(setter.getModifiers())</div><div class="line">                &amp;&amp; setter.getParameterTypes().length == <span class="number">1</span>) &#123;</div><div class="line">            Class&lt;?&gt; type = setter.getParameterTypes()[<span class="number">0</span>];</div><div class="line">            String property = StringUtils.camelToSplitName(name.substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + name.substring(<span class="number">4</span>), <span class="string">"-"</span>);</div><div class="line">            <span class="keyword">if</span>(...)&#123;</div><div class="line">                <span class="comment">// some ops...</span></div><div class="line">            &#125;<span class="keyword">else</span> &#123;</div><div class="line">                String value = element.getAttribute(property);</div><div class="line">                <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</div><div class="line">                    value = value.trim();</div><div class="line">                    <span class="keyword">if</span> (value.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                           <span class="comment">// 部分省略...</span></div><div class="line">                            Object reference;</div><div class="line">                            <span class="keyword">if</span> (isPrimitive(type)) &#123;</div><div class="line">                                <span class="keyword">if</span> (<span class="string">"async"</span>.equals(property) &amp;&amp; <span class="string">"false"</span>.equals(value)</div><div class="line">                                        || <span class="string">"timeout"</span>.equals(property) &amp;&amp; <span class="string">"0"</span>.equals(value)</div><div class="line">                                        || <span class="string">"delay"</span>.equals(property) &amp;&amp; <span class="string">"0"</span>.equals(value)</div><div class="line">                                        || <span class="string">"version"</span>.equals(property) &amp;&amp; <span class="string">"0.0.0"</span>.equals(value)</div><div class="line">                                        || <span class="string">"stat"</span>.equals(property) &amp;&amp; <span class="string">"-1"</span>.equals(value)</div><div class="line">                                        || <span class="string">"reliable"</span>.equals(property) &amp;&amp; <span class="string">"false"</span>.equals(value)) &#123;</div><div class="line">                                    <span class="comment">// 兼容旧版本xsd中的default值</span></div><div class="line">                                    value = <span class="keyword">null</span>;</div><div class="line">                                &#125;</div><div class="line">                                reference = value;</div><div class="line">                            &#125; </div><div class="line"></div><div class="line">                            <span class="comment">// 大批省略...</span></div><div class="line"></div><div class="line">                            <span class="comment">// 这里会将interface这个attribute的值设置在ReferenceBean的父类ReferenceConfig的interfaceName上通过method:setInterface(String)</span></div><div class="line">                            beanDefinition.getPropertyValues().addPropertyValue(property, reference);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 省略...</span></div><div class="line">    <span class="keyword">return</span> beanDefinition;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面两个关键的属性值id,interface都设置在了bean上，后面会用到。ReferenceConfig中的settter:setInterface用来设置interface：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInterface</span><span class="params">(String interfaceName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.interfaceName = interfaceName;</div><div class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span> || id.length() == <span class="number">0</span>) &#123;</div><div class="line">            id = interfaceName;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>参考ReferenceBean Hierarchy:</p>
<p><img src="http://ww1.sinaimg.cn/mw690/50508d62gw1fa1b4h76xgj21960van07.jpg" alt="ReferenceBean Hierarchy"></p>
<p>ReferenceBean中包含以几个两个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// inherit from ApplicationContextAware</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.applicationContext = applicationContext;</div><div class="line">  SpringExtensionFactory.addApplicationContext(applicationContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="comment">// inherit from FactoryBean</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">  <span class="keyword">return</span> get();<span class="comment">// 调用ReferenceConfig#get()方法创建类型为getObjectType()的对象，which in this case is instance of x.y.z.DemoService</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// inherit from FactoryBean</span></div><div class="line"><span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</div><div class="line">  <span class="keyword">return</span> getInterfaceClass();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如此，重点关注ReferenceConfig#get(),follow up:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (destroyed)&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already destroyed!"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</div><div class="line">    init();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> ref;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>进入init():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// some ops...</span></div><div class="line">     &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 之前设置的interface:x.y.z.DemoService</span></div><div class="line">            interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread()</div><div class="line">                    .getContextClassLoader());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">        checkInterfaceAndMethods(interfaceClass, methods);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// a lot of ops...</span></div><div class="line">    ref = createProxy(map);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>进入createProxy(Map):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createProxy</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</div><div class="line">    <span class="comment">//some ops...</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (urls.size() == <span class="number">1</span>) &#123;</div><div class="line">        invoker = refprotocol.refer(interfaceClass, urls.get(<span class="number">0</span>));</div><div class="line">    &#125; </div><div class="line"></div><div class="line">    <span class="comment">// some ops...</span></div><div class="line"></div><div class="line">    <span class="comment">// 创建服务代理</span></div><div class="line">    <span class="keyword">return</span> (T) proxyFactory.getProxy(invoker);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里已经知道代理是由ProxyFactory创建了，接下重点看看ProxyFactory.</p>
<h2 id="ProxyFactory"><a href="#ProxyFactory" class="headerlink" title="ProxyFactory"></a>ProxyFactory</h2><p>ProxyFactory  Hierarchy:</p>
<p><img src="http://ww4.sinaimg.cn/mw690/50508d62gw1fa27gqakyxj20l8080gmy.jpg" alt="ProxyFactory Hierarchy"></p>
<h3 id="AbstractProxyFactory"><a href="#AbstractProxyFactory" class="headerlink" title="AbstractProxyFactory"></a>AbstractProxyFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</div><div class="line">  Class&lt;?&gt;[] interfaces = <span class="keyword">null</span>;</div><div class="line">  <span class="comment">// createProxy时创建invoker时已将interface传入</span></div><div class="line">  String config = invoker.getUrl().getParameter(<span class="string">"interfaces"</span>);</div><div class="line">  <span class="keyword">if</span> (config != <span class="keyword">null</span> &amp;&amp; config.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">    String[] types = Constants.COMMA_SPLIT_PATTERN.split(config);</div><div class="line">    <span class="keyword">if</span> (types != <span class="keyword">null</span> &amp;&amp; types.length &gt; <span class="number">0</span>) &#123;</div><div class="line">      interfaces = <span class="keyword">new</span> Class&lt;?&gt;[types.length + <span class="number">2</span>];</div><div class="line">      interfaces[<span class="number">0</span>] = invoker.getInterface();</div><div class="line">      interfaces[<span class="number">1</span>] = EchoService.class;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; types.length; i ++) &#123;</div><div class="line">        interfaces[i + <span class="number">1</span>] = ReflectUtils.forName(types[i]);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (interfaces == <span class="keyword">null</span>) &#123;</div><div class="line">    interfaces = <span class="keyword">new</span> Class&lt;?&gt;[] &#123;invoker.getInterface(), EchoService.class&#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 调用子类的实现</span></div><div class="line">  <span class="keyword">return</span> getProxy(invoker, interfaces);</div></pre></td></tr></table></figure>
<h3 id="JavassistProxyFactory"><a href="#JavassistProxyFactory" class="headerlink" title="JavassistProxyFactory"></a>JavassistProxyFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (T) Proxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getProxy</code>的相关代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Proxy <span class="title">getProxy</span><span class="params">(Class&lt;?&gt;... ics)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">return</span> getProxy(ClassHelper.getCallerClassLoader(Proxy.class), ics);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>动态类的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Proxy <span class="title">getProxy</span><span class="params">(ClassLoader cl, Class&lt;?&gt;... ics)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">//some ops...</span></div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            ccp = ClassGenerator.newInstance(cl);</div><div class="line"></div><div class="line">            Set&lt;String&gt; worked = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">            List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;Method&gt;();</div><div class="line"></div><div class="line">            <span class="comment">// 反射获取interface的相关信息并build code string，然后交给javassist动态生成实现类。</span></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ics.length;i++)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span>( !Modifier.isPublic(ics[i].getModifiers()) )</div><div class="line">                &#123;</div><div class="line">                    String npkg = ics[i].getPackage().getName();</div><div class="line">                    <span class="keyword">if</span>( pkg == <span class="keyword">null</span> )</div><div class="line">                    &#123;</div><div class="line">                        pkg = npkg;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">if</span>( !pkg.equals(npkg)  )</div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"non-public interfaces from different packages"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                ccp.addInterface(ics[i]);</div><div class="line"></div><div class="line">                <span class="keyword">for</span>( Method method : ics[i].getMethods() )</div><div class="line">                &#123;</div><div class="line">                    String desc = ReflectUtils.getDesc(method);</div><div class="line">                    <span class="keyword">if</span>( worked.contains(desc) )</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    worked.add(desc);</div><div class="line"></div><div class="line">                    <span class="keyword">int</span> ix = methods.size();</div><div class="line">                    Class&lt;?&gt; rt = method.getReturnType();</div><div class="line">                    Class&lt;?&gt;[] pts = method.getParameterTypes();</div><div class="line"></div><div class="line">                    StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="string">"Object[] args = new Object["</span>).append(pts.length).append(<span class="string">"];"</span>);</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;pts.length;j++)</div><div class="line">                        code.append(<span class="string">" args["</span>).append(j).append(<span class="string">"] = ($w)$"</span>).append(j+<span class="number">1</span>).append(<span class="string">";"</span>);</div><div class="line">                    <span class="comment">// 注意这里 handler.invoke(),代理的统一处理</span></div><div class="line">                    code.append(<span class="string">" Object ret = handler.invoke(this, methods["</span> + ix + <span class="string">"], args);"</span>);</div><div class="line">                    <span class="keyword">if</span>( !Void.TYPE.equals(rt) )</div><div class="line">                        code.append(<span class="string">" return "</span>).append(asArgument(rt, <span class="string">"ret"</span>)).append(<span class="string">";"</span>);</div><div class="line"></div><div class="line">                    methods.add(method);</div><div class="line">                    ccp.addMethod(method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>( pkg == <span class="keyword">null</span> )</div><div class="line">                pkg = PACKAGE_NAME;</div><div class="line"></div><div class="line">            <span class="comment">// 接口的实现类</span></div><div class="line">            String pcn = pkg + <span class="string">".proxy"</span> + id;</div><div class="line">            ccp.setClassName(pcn);</div><div class="line">            ccp.addField(<span class="string">"public static java.lang.reflect.Method[] methods;"</span>);</div><div class="line">            ccp.addField(<span class="string">"private "</span> + InvocationHandler.class.getName() + <span class="string">" handler;"</span>);</div><div class="line">            ccp.addConstructor(Modifier.PUBLIC, <span class="keyword">new</span> Class&lt;?&gt;[]&#123; InvocationHandler.class &#125;, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="string">"handler=$1;"</span>); <span class="comment">// $1等表示传入的参数，具体参考javassist官方文档</span></div><div class="line">            ccp.addDefaultConstructor();</div><div class="line">            Class&lt;?&gt; clazz = ccp.toClass();</div><div class="line">            clazz.getField(<span class="string">"methods"</span>).set(<span class="keyword">null</span>, methods.toArray(<span class="keyword">new</span> Method[<span class="number">0</span>]));</div><div class="line"></div><div class="line">            <span class="comment">// 生成当前Proxy的子类，实现newInstance()方法</span></div><div class="line">            String fcn = Proxy.class.getName() + id;</div><div class="line">            ccm = ClassGenerator.newInstance(cl);</div><div class="line">            ccm.setClassName(fcn);</div><div class="line">            ccm.addDefaultConstructor();</div><div class="line">            ccm.setSuperClass(Proxy.class);</div><div class="line">            ccm.addMethod(<span class="string">"public Object newInstance("</span> + InvocationHandler.class.getName() + <span class="string">" h)&#123; return new "</span> + pcn + <span class="string">"($1); &#125;"</span>);</div><div class="line">            Class&lt;?&gt; pc = ccm.toClass();</div><div class="line">            proxy = (Proxy)pc.newInstance();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// some ops...</span></div><div class="line">        <span class="keyword">return</span> proxy;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>toClass()</code> 为ClassGenerator的方法，实现也是通过javassist生成动态类。 这儿返回的是Proxy的子类实例。JavassistProxyFactory的getProxy中<code>Proxy.getProxy(interfaces).newInstance(new InvokerInvocationHandler(invoker));</code>这儿的newInstance()就属于这个子类实例。该方法的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler handler)</span></span>;</div></pre></td></tr></table></figure>
<p>再来看看InvocationHandler的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;?&gt; invoker;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.invoker = handler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        String methodName = method.getName();</div><div class="line">        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">        <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">            <span class="keyword">return</span> method.invoke(invoker, args);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"toString"</span>.equals(methodName) &amp;&amp; parameterTypes.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> invoker.toString();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"hashCode"</span>.equals(methodName) &amp;&amp; parameterTypes.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> invoker.hashCode();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"equals"</span>.equals(methodName) &amp;&amp; parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> invoker.equals(args[<span class="number">0</span>]);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 返回远程调用的结果</span></div><div class="line">        <span class="keyword">return</span> invoker.invoke(<span class="keyword">new</span> RpcInvocation(method, args)).recreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到这儿可能还有点迷糊，invoke是在哪里调用的呢？回头看看动态类生成部分有这样一段代码:</p>
<p><code>code.append(&quot; Object ret = handler.invoke(this, methods[&quot; + ix + &quot;], args);&quot;);</code>这就将代理调用衔接起来了。看起来可能有点抽象，待下面来试验一把。</p>
<h4 id="试验"><a href="#试验" class="headerlink" title="试验"></a>试验</h4><p><code>DemoService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.examples.x.y.z;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by tangwei on 2016/11/23.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHi</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Main.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.examples.demo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.URL;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.examples.x.y.z.DemoService;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.support.MockInvoker;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by tangwei on 2016/11/22.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> JavassistProxyFactory().getProxy(<span class="keyword">new</span> MockInvoker&lt;DemoService&gt;(<span class="keyword">new</span> URL(<span class="string">""</span>, <span class="string">""</span>, <span class="number">8888</span>)),</div><div class="line">                <span class="keyword">new</span> Class[]&#123;DemoService.class&#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>ClassGenerator</code>中 toClass返回前加入以下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="comment">// 将class写入文件</span></div><div class="line">  mCtc.writeFile(<span class="string">"/path/to/save/classfile/"</span>+mSuperClass);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">  e.printStackTrace();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> mCtc.toClass(loader, pd);</div></pre></td></tr></table></figure>
<p>debug一下main,在动态生成类的时候将类写入文件中，结果如下：</p>
<p>DemoService的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></div><div class="line"><span class="comment">// (powered by Fernflower decompiler)</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.common.bytecode;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.ClassGenerator.DC;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.examples.x.y.z.DemoService;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy0</span> <span class="keyword">implements</span> <span class="title">DC</span>, <span class="title">DemoService</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method[] methods;</div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHi</span><span class="params">(String var1)</span> </span>&#123;</div><div class="line">        Object[] var2 = <span class="keyword">new</span> Object[]&#123;var1&#125;;</div><div class="line">        <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], var2);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy0</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">proxy0</span><span class="params">(InvocationHandler var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.handler = var1;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Proxy的子类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></div><div class="line"><span class="comment">// (powered by Fernflower decompiler)</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.common.bytecode;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.Proxy;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.proxy0;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.bytecode.ClassGenerator.DC;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">DC</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler var1)</span> </span>&#123;</div><div class="line">        <span class="comment">// 返回的是DemoService的实例</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> proxy0(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy0</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中DC接口只是一个标识接口，表示该类是动态生成的。这样看起来就比较清晰明了了。下面再来看看jdk的proxy。</p>
<h3 id="JdkProxyFactory"><a href="#JdkProxyFactory" class="headerlink" title="JdkProxyFactory"></a>JdkProxyFactory</h3><p>相关代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxyFactory</span> <span class="keyword">extends</span> <span class="title">AbstractProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, <span class="keyword">new</span> InvokerInvocationHandler(invoker));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractProxyInvoker&lt;T&gt;(proxy, type, url) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Object <span class="title">doInvoke</span><span class="params">(T proxy, String methodName, </span></span></div><div class="line"><span class="function"><span class="params">                                      Class&lt;?&gt;[] parameterTypes, </span></span></div><div class="line"><span class="function"><span class="params">                                      Object[] arguments)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                Method method = proxy.getClass().getMethod(methodName, parameterTypes);</div><div class="line">                <span class="keyword">return</span> method.invoke(proxy, arguments);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到<code>Proxy.newProxyInstance</code>直接使用的是JDK的动态代理机制，因此就不再跟下去了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，对dubbo本地动态代理有一个清晰的理解了，总的来说一路顺藤摸瓜还算顺畅。对于选择哪一中方式作为生产使用，Dubbo推荐使用Javassist的代理机制，因为jdk原生的动态代理性能较差，生产环境不宜使用。</p>
</div><div class="tags"><a href="/tags/dubbo/">dubbo</a><a href="/tags/proxy/">proxy</a><a href="/tags/javassist/">javassist</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2016/12/06/日志清理脚本-md/" class="pre">日志清理脚本</a><a href="/2016/11/01/Spring可扩展的XML配置/" class="next">Spring可扩展的XML配置</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Dubbo学习-理解动态代理"><span class="toc-text">Dubbo学习-理解动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#本次研究目标"><span class="toc-text">本次研究目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预备知识"><span class="toc-text">预备知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-dig-in"><span class="toc-text">How to dig in?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ProxyFactory"><span class="toc-text">ProxyFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractProxyFactory"><span class="toc-text">AbstractProxyFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavassistProxyFactory"><span class="toc-text">JavassistProxyFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#试验"><span class="toc-text">试验</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdkProxyFactory"><span class="toc-text">JdkProxyFactory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/06/wkhtmltopdf折腾记/">wkhtmltopdf折腾记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/06/日志清理脚本-md/">日志清理脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/Dubbo学习-理解动态代理/">Dubbo学习-理解动态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/Spring可扩展的XML配置/">Spring可扩展的XML配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/18/bootcamp/">bootcamp</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/深入理解HashMap/">深入理解HashMap</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/22/effective-java-methods/">effective-java-methods</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/how-to-create-products-customers-love/">how-to-create-products-customers-love</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/27/Build-rest-api/">Build-rest-api</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/03/RESTAPI-Reference/">RESTAPI-Reference</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/dubbo/">dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/effective/" style="font-size: 15px;">effective</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/javassist/" style="font-size: 15px;">javassist</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/PM/" style="font-size: 15px;">PM</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/wkhtmltopdf/" style="font-size: 15px;">wkhtmltopdf</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">About</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">三唐.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>