<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="三唐"><meta name="description" content="Spring可扩展的XML配置Spring自从2.0开始就为基础的xml格式提供了一个基于xmlschema的扩展机制，用于定义和配置beans。本文基于此简单讲解如果定义自己的BeanDefinitionParser和如何将定义好的parsers集成到SpringIoC"><meta name="keywords" content="dubbo"><title>Spring可扩展的XML配置 · 三唐</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2016/11/01/Spring可扩展的XML配置/"><link rel="alternative" href="/atom.xml" title="三唐" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">三唐</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories/" target="_self">Categories</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Spring可扩展的XML配置</h1><span class="post-time">Nov 1, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring__u53EF_u6269_u5C55_u7684XML_u914D_u7F6E"><span class="toc-text">Spring 可扩展的XML配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#u521B_u5EFAschema_u6587_u4EF6"><span class="toc-text">创建schema文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u5B9E_u73B0NamespaceHandler"><span class="toc-text">实现NamespaceHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u5B9E_u73B0BeanDefinitionParser"><span class="toc-text">实现BeanDefinitionParser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u6CE8_u518Chandler_and_schema"><span class="toc-text">注册handler and schema</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#META-INF/spring-handlers"><span class="toc-text">META-INF/spring.handlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#META-INF/spring-schemas"><span class="toc-text">META-INF/spring.schemas</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Now_2Ctime_to_test"><span class="toc-text">Now,time to test</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dubbo_xml__u914D_u7F6E_u6269_u5C55"><span class="toc-text">Dubbo xml 配置扩展</span></a></li></ol></li></ol></div><div class="post-content"><h1 id="Spring__u53EF_u6269_u5C55_u7684XML_u914D_u7F6E"><a href="#Spring__u53EF_u6269_u5C55_u7684XML_u914D_u7F6E" class="headerlink" title="Spring 可扩展的XML配置"></a>Spring 可扩展的XML配置</h1><p>Spring 自从2.0开始就为基础的xml格式提供了一个基于xml schema的扩展机制，用于定义和配置beans。本文基于此简单讲解如果定义自己的<code>BeanDefinitionParser</code>和如何将定义好的<code>parsers</code>集成到<code>Spring IoC container</code>中。</p>
<p>创建一个xml配置扩展可以通过以下4步完成：</p>
<ol>
<li>创建一个xml schema来描述你自定的xml元素。</li>
<li>编写一个<code>NamespaceHandler</code>的具体实现。</li>
<li>编写一个或者多个<code>BeanDefinitionParser</code>的实现。主要的工作都在此步骤完成。</li>
<li>关联<code>xsd</code>,<code>NamespaceHandler</code>。</li>
</ol>
<p>下面依照以上四个步骤并附一个示例详细讲解。完整代码放在码云上:<a href="https://git.oschina.net/android-speeder/springcustomxml.git" target="_blank" rel="external">https://git.oschina.net/android-speeder/springcustomxml.git</a></p>
<a id="more"></a>
<h2 id="u521B_u5EFAschema_u6587_u4EF6"><a href="#u521B_u5EFAschema_u6587_u4EF6" class="headerlink" title="创建schema文件"></a>创建schema文件</h2><p>创建一个spring可以用的xml配置扩展首先需要定义一个xml schema来描述这个扩展。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">xsd:schema</span> <span class="attribute">xmlns</span>=<span class="value">"http://daveztong.github.io/schema/dz"</span></span><br><span class="line">            <span class="attribute">xmlns:xsd</span>=<span class="value">"http://www.w3.org/2001/XMLSchema"</span></span><br><span class="line">            <span class="attribute">xmlns:beans</span>=<span class="value">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">            <span class="attribute">targetNamespace</span>=<span class="value">"http://daveztong.github.io/schema/dz"</span></span><br><span class="line">            <span class="attribute">elementFormDefault</span>=<span class="value">"qualified"</span></span><br><span class="line">            <span class="attribute">attributeFormDefault</span>=<span class="value">"unqualified"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">xsd:import</span> <span class="attribute">namespace</span>=<span class="value">"http://www.springframework.org/schema/beans"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">xsd:element</span> <span class="attribute">name</span>=<span class="value">"person"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">xsd:complexType</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">xsd:complexContent</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">xsd:extension</span> <span class="attribute">base</span>=<span class="value">"beans:identifiedType"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">xsd:attribute</span> <span class="attribute">name</span>=<span class="value">"name"</span> <span class="attribute">type</span>=<span class="value">"xsd:string"</span> <span class="attribute">use</span>=<span class="value">"required"</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">xsd:attribute</span> <span class="attribute">name</span>=<span class="value">"age"</span> <span class="attribute">type</span>=<span class="value">"xsd:int"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">xsd:extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">xsd:complexContent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">xsd:complexType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">xsd:element</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">xsd:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意<code>&lt;xsd:extension base=&quot;beans:identifiedType&quot;&gt;</code>表示该tag含有一个id属性并且会被spring container用于识别该bean。使用该属性的前提是需要导入<code>&lt;xsd:import namespace=&quot;http://www.springframework.org/schema/beans&quot;/&gt;</code>。</p>
<h2 id="u5B9E_u73B0NamespaceHandler"><a href="#u5B9E_u73B0NamespaceHandler" class="headerlink" title="实现NamespaceHandler"></a>实现NamespaceHandler</h2><p>当spring在解析xml时遇到该namespace就需要使用自定义的<code>Namespacehandler</code>去解析所有该名称空间下的元素。</p>
<p><code>NamespaceHandler</code>只包含三个方法:</p>
<ul>
<li><code>init()</code>: 用于初始化<code>NamespaceHandler</code>。</li>
<li><code>BeanDefinition parse(Element, ParserContext)</code>：当spring遇到顶级的元素时才会调用。该方法可以直接返回一个bean definition或者自己注册一个。</li>
<li><code>BeanDefinitionHolder decorate(Node, BeanDefinitionHolder, ParserContext)</code>:当spring遇到属性定义或者嵌套在不同名称空间下的元素时才会被调用。</li>
</ul>
<p>我们可以自己实现<code>NamespaceHandler</code>,但是基于spring的惯例，一般都会提供一个基础类简化开发人员的工作，所以我们可以直接继承spring提供的<code>NamespaceHandlerSupport</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.daveztong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by tangwei on 2016/10/31.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DZNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span></span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"person"</span>,<span class="keyword">new</span> PersonBeanDefinitionParser());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>DZNamespaceHandler</code>的代码量很少，因为真正的解析工作都委托给了<code>BeanDefinitionParser</code>。    <code>NamespaceHandler</code>支持注册任意多个<code>BeanDefinitionParser</code>,当其需要解析其所负责的名称空间下的元素时就会将解析工作委托给注册的<code>BeanDefinitionParser</code>。</p>
<h2 id="u5B9E_u73B0BeanDefinitionParser"><a href="#u5B9E_u73B0BeanDefinitionParser" class="headerlink" title="实现BeanDefinitionParser"></a>实现<code>BeanDefinitionParser</code></h2><p>当<code>NamespaceHandler</code>遇到一个与注册列表中key匹配的xml元素时就会将该元素的解析任务交给与key对应的<code>BeanDefinitionParser</code>。在本例中则是<code>PersonBeanDefinitionParser</code>。也就是说一个<code>BeanDefinitionParser</code>仅负责解析定义在指定schema中的一个唯一顶级的xml元素。在parser中我们可以访问到其负责解析的元素和子元素的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.daveztong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by tangwei on 2016/10/31.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</span><br><span class="line">        <span class="keyword">return</span> Person.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</span><br><span class="line">        String name = element.getAttribute(<span class="string">"name"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(name)) &#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">"name"</span>, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String age = element.getAttribute(<span class="string">"age"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(age)) &#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">"age"</span>, Integer.parseInt(age));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编码部分就这么多，是不是so easy! 可能有人会疑问，为什么没有看到<code>BeanDefiniiton</code>的创建，那是因为创建的工作由<code>AbstractSingleBeanDefinitionParser#parseInternal</code>完成了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> AbstractBeanDefinition <span class="title">parseInternal</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line">		String parentName = getParentName(element);</span><br><span class="line">		<span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">			builder.getRawBeanDefinition().setParentName(parentName);</span><br><span class="line">		&#125;</span><br><span class="line">		Class&lt;?&gt; beanClass = getBeanClass(element);</span><br><span class="line">		<span class="keyword">if</span> (beanClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">			builder.getRawBeanDefinition().setBeanClass(beanClass);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			String beanClassName = getBeanClassName(element);</span><br><span class="line">			<span class="keyword">if</span> (beanClassName != <span class="keyword">null</span>) &#123;</span><br><span class="line">				builder.getRawBeanDefinition().setBeanClassName(beanClassName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</span><br><span class="line">		<span class="keyword">if</span> (parserContext.isNested()) &#123;</span><br><span class="line">			<span class="comment">// Inner bean definition must receive same scope as containing bean.</span></span><br><span class="line">			builder.setScope(parserContext.getContainingBeanDefinition().getScope());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (parserContext.isDefaultLazyInit()) &#123;</span><br><span class="line">			<span class="comment">// Default-lazy-init applies to custom bean definitions as well.</span></span><br><span class="line">			builder.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		doParse(element, parserContext, builder);</span><br><span class="line">		<span class="keyword">return</span> builder.getBeanDefinition();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>The last statement <code>builder.getBeanDefinition();</code>返回了我们需要的bean. 继续看builder.getBeanDefinition()的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">getBeanDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.beanDefinition.validate();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.beanDefinition;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>That’s our bean!</p>
<p>编码部分是完成了，但是spring还不知道他们的存在，接下来就需要让spring aware of them!(aware是个很关键的词啊，在spring的代码里随处可见^_^)</p>
<h2 id="u6CE8_u518Chandler_and_schema"><a href="#u6CE8_u518Chandler_and_schema" class="headerlink" title="注册handler and schema"></a>注册handler and schema</h2><p>要让spring aware of out handler and xsd schema,我们需要在两个特殊的properties文件中注册他们。这些properties文件需要放在<code>META-INF</code>目录下面,并且可以和jar包一起发布。spring的解析框架通过这些特殊的properties文件就能pick up our handler and schema!</p>
<h3 id="META-INF/spring-handlers"><a href="#META-INF/spring-handlers" class="headerlink" title="META-INF/spring.handlers"></a>META-INF/spring.handlers</h3><p><code>spring.handlers</code>包含了 xml schema uri 和namespace handler之间的k-v映射关系，如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://daveztong.github.io/schema/dz=io.github.daveztong.DZNamespaceHandler</span><br></pre></td></tr></table></figure>
<p>注意，因为<code>:</code>在properties文件中是个合法的分隔符，所以需要escape以下！</p>
<p>其中URI部分是自定义的namespace扩展，必须与xsd中的<code>targetNamespace</code>完全匹配。</p>
<h3 id="META-INF/spring-schemas"><a href="#META-INF/spring-schemas" class="headerlink" title="META-INF/spring.schemas"></a>META-INF/spring.schemas</h3><p><code>spring.schemas</code>中包含了xml schema uri(对应<code>xsi:schemaLocation</code>的值)与classpath resources的映射关系。如果这个文件不存在，spring默认会从网上加载<code>xsi:schemaLocation</code>中所定义的schema。有个这个映射文件，spring就会从classpath中加载而不再联网查找。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://daveztong.github.io/schema/dz/dz.xsd=io/github/daveztong/schema/dz/dz.xsd</span><br></pre></td></tr></table></figure>
<h2 id="Now_2Ctime_to_test"><a href="#Now_2Ctime_to_test" class="headerlink" title="Now,time to test"></a>Now,time to test</h2><p>使用xml定义person bean: spring-beans.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       <span class="attribute">xmlns:dz</span>=<span class="value">"http://daveztong.github.io/schema/dz"</span></span><br><span class="line">       <span class="attribute">xsi:schemaLocation</span>=<span class="value">"</span><br><span class="line">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">http://daveztong.github.io/schema/dz http://daveztong.github.io/schema/dz/dz.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- as a top-level bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">dz:person</span> <span class="attribute">age</span>=<span class="value">"22"</span> <span class="attribute">id</span>=<span class="value">"person"</span> <span class="attribute">name</span>=<span class="value">"tangwei"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>为了演示效果，这里使用spring boot来快速测试: <code>App.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.daveztong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by tangwei on 2016/11/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@EnableAutoConfiguration</span></span><br><span class="line"><span class="annotation">@Controller</span></span><br><span class="line"><span class="annotation">@ImportResource</span>(<span class="string">"classpath:spring-beans.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="annotation">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showPerson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> person.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问<a href="http://localhost:8080/" target="_blank" rel="external">http://localhost:8080/</a> ,dada:</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person&#123;age=<span class="number">22</span>, name=<span class="string">'tangwei'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>说了这么多，到底谁在用这个，能干啥呢！</p>
<h2 id="Dubbo_xml__u914D_u7F6E_u6269_u5C55"><a href="#Dubbo_xml__u914D_u7F6E_u6269_u5C55" class="headerlink" title="Dubbo xml 配置扩展"></a>Dubbo xml 配置扩展</h2><p>Dubbo 在国内开源RPC界算是比较知名的，她其实采用的就是这种方式解析自定义的配置。dubbo jar 包结构:</p>
<p><img src="http://ww4.sinaimg.cn/large/94dc19degw1f9cgo55oetj209q06hmxg.jpg" alt="dubbo jar structure"></p>
<p>spring.handlers:</p>
<p><code>http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</code></p>
<p>spring.schemas:</p>
<p><code>http\://code.alibabatech.com/schema/dubbo/dubbo.xsd=META-INF/dubbo.xsd</code></p>
<p>NamespaceHandler实现为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		Version.checkDuplicate(DubboNamespaceHandler.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	    registerBeanDefinitionParser(<span class="string">"application"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ApplicationConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"module"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ModuleConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"registry"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(RegistryConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"monitor"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(MonitorConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"provider"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ProviderConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"consumer"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ConsumerConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"protocol"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ProtocolConfig.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"service"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ServiceBean.class, <span class="keyword">true</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"reference"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(ReferenceBean.class, <span class="keyword">false</span>));</span><br><span class="line">        registerBeanDefinitionParser(<span class="string">"annotation"</span>, <span class="keyword">new</span> DubboBeanDefinitionParser(AnnotationBean.class, <span class="keyword">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该handler注册了所有的bean definition parser!</p>
<p>了解这种机制后，我们也可以根据自己需要做任何配置扩展。So cool!</p>
</div></article><div class="tags"><a href="/tags/dubbo/">dubbo</a></div><div class="paginator"><a href="/2016/11/23/Dubbo学习-理解动态代理/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a><a href="/2016/07/18/bootcamp/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yoursite.com/2016/11/01/Spring可扩展的XML配置/';
    this.page.identifier = '2016/11/01/Spring可扩展的XML配置/';
    this.page.title = 'Spring可扩展的XML配置';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//santang.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="social"><a href="mailto:daveztong@gmail.com" title="email" class="iconfont icon-email"></a><a href="http://stackoverflow.com/users/1388881/daveztong" title="stack-overflow" class="iconfont icon-stack-overflow"></a><a href="/atom.xml" title="rss" class="iconfont icon-rss"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">三唐</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>